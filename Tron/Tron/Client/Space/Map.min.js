var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},Map=function(n){function t(){var i,r;for(n.call(this),this._halfMapSize=new Size(t.MAP_SIZE.Width*.5,t.MAP_SIZE.Height*.5),this._dimensions=new Size(t.MAP_SIZE.Width/t.FLOOR_TILE_SIZE.Width,t.MAP_SIZE.Height/t.FLOOR_TILE_SIZE.Height),this._map=[],this._cycles={},i=0;i<this._dimensions.Width;i++)for(this._map[i]=[],r=0;r<this._dimensions.Height;r++)this._map[i][r]=0}return __extends(t,n),t.FLOOR_TILE_SIZE=new Size(100),t.MAP_SIZE=new Size(1e4),t.WALL_SIZE=new Size(t.MAP_SIZE.Width,2e3),t.prototype.getCycleMapLocation=function(n){var i=n.Context.position.clone();return n.MovementController.Velocity.z!=0?i.z-=i.z%t.FLOOR_TILE_SIZE.Width-t.FLOOR_TILE_SIZE.Width*(n.MovementController.Velocity.z/Math.abs(n.MovementController.Velocity.z)):n.MovementController.Velocity.x!=0&&(i.x-=i.x%t.FLOOR_TILE_SIZE.Width-t.FLOOR_TILE_SIZE.Width*(n.MovementController.Velocity.x/Math.abs(n.MovementController.Velocity.x))),new MapLocation(Math.abs((i.z+this._halfMapSize.Height)/t.FLOOR_TILE_SIZE.Height),Math.abs((i.x+this._halfMapSize.Width)/t.FLOOR_TILE_SIZE.Width))},t.prototype.updateMap=function(){var r,n,t,i;for(r in this._cycles)n=this._cycles[r],n.Alive&&(t=this.getCycleMapLocation(n),t.Row<0||t.Row>=this._dimensions.Height||t.Column<0||t.Column>=this._dimensions.Width?n.HandleCollisionWith(null):(i=this._map[t.Row][t.Column],i==0?(this._map[n.HeadLocation.Row][n.HeadLocation.Column]=n.ID,n.HeadLocation=t,this._map[t.Row][t.Column]=-n.ID):i!=-n.ID&&(i<0&&this._cycles[Math.abs(i)].HandleCollisionWith(n),n.HandleCollisionWith(this._cycles[Math.abs(i)]))))},t.prototype.AddAll=function(n){for(var t=n.length-1;t>=0;t--)this.Add(n[t])},t.prototype.Add=function(n){n.HeadLocation=this.getCycleMapLocation(n),this._cycles[n.ID]=n},t.prototype.Remove=function(n){delete this._cycles[n]},t.prototype.Update=function(){var n,t;for(n in this._cycles)t=this._cycles[n],this.AddAllToScene(t.TrailManager.PullPendingContexts())},t}(SceneObjectCreator)